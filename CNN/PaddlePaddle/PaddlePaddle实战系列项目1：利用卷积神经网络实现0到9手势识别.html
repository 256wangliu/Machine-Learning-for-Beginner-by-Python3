<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PaddlePaddle实战系列项目1：利用卷积神经网络实现0到9手势识别</title>
  <link rel="stylesheet" href="https://stackedit.io/style.css" />
</head>

<body class="stackedit">
  <div class="stackedit__html"><p>在百度AI框架PaddlePaddle下，利用卷积神经网络CNN实现数字0到9手势的分类识别。</p>
<h5><a id="_1"></a>一、数据集说明</h5>
<ol>
<li><strong>数据集下载</strong><br>
<a href="https://aistudio.baidu.com/aistudio/datasetdetail/29044">https://aistudio.baidu.com/aistudio/datasetdetail/29044</a></li>
<li><strong>数据集说明</strong><br>
数据集内容： 图片中的手势表示0-9这10个数字，其中数据集解压后文件夹的名称就是该文件夹中的图片中的手势表示的数字；<br>
数据集来源： 百度AI Studio data数据集；<br>
图片说明： 彩色照片，大小100*100像素，背景统一为白色；</li>
<li><strong>各类别数量</strong></li>
</ol>
<pre><code class="prism language-python"><span class="token comment"># 解压缩数据集</span>
!cd <span class="token operator">/</span>home<span class="token operator">/</span>aistudio<span class="token operator">/</span>data<span class="token operator">/</span>data29044 <span class="token operator">&amp;</span><span class="token operator">&amp;</span> unzip <span class="token operator">-</span>q <span class="token operator">-</span>o GestureC<span class="token punctuation">.</span><span class="token builtin">zip</span>
<span class="token comment"># 引入依赖的各种包</span>
<span class="token keyword">import</span> os
<span class="token comment"># 统计各种类别图片的个数</span>
<span class="token keyword">def</span> <span class="token function">get_sample_count</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    digital_count_dict <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">for</span> files <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        count <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">for</span> filename <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span><span class="token string">'%s/%s'</span> <span class="token operator">%</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> files<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            count <span class="token operator">+=</span> <span class="token number">1</span>
        digital_count_dict<span class="token punctuation">[</span>files<span class="token punctuation">]</span> <span class="token operator">=</span> count
    <span class="token keyword">return</span> digital_count_dict
<span class="token comment"># 各个类别图片的个数</span>
get_sample_count<span class="token punctuation">(</span>r<span class="token string">'data/data29044/GestureC'</span><span class="token punctuation">)</span>

<span class="token punctuation">{</span><span class="token string">'8'</span><span class="token punctuation">:</span> <span class="token number">208</span><span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">:</span> <span class="token number">205</span><span class="token punctuation">,</span> <span class="token string">'9'</span><span class="token punctuation">:</span> <span class="token number">204</span><span class="token punctuation">,</span><span class="token string">'7'</span><span class="token punctuation">:</span> <span class="token number">206</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">:</span> <span class="token number">206</span><span class="token punctuation">,</span> <span class="token string">'5'</span><span class="token punctuation">:</span> <span class="token number">207</span><span class="token punctuation">,</span> <span class="token string">'3'</span><span class="token punctuation">:</span> <span class="token number">206</span><span class="token punctuation">,</span><span class="token string">'6'</span><span class="token punctuation">:</span> <span class="token number">207</span><span class="token punctuation">,</span> <span class="token string">'4'</span><span class="token punctuation">:</span> <span class="token number">207</span><span class="token punctuation">,</span> <span class="token string">'2'</span><span class="token punctuation">:</span> <span class="token number">206</span><span class="token punctuation">}</span>
</code></pre>
<h5><a id="_30"></a>二、数据集处理</h5>
<ol>
<li><strong>将数据集中图片的路径变为PaddlePaddle中的.list形式</strong></li>
</ol>
<pre><code class="prism language-python"><span class="token comment"># 将数据集中的图片的路径写入该框架下的.list格式的文件, 每一行的前半部分是图片路径，一个空格后面是该图片手势表示的数字</span>
<span class="token keyword">def</span> <span class="token function">make_path_list</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token string">'./alldata.list'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        os<span class="token punctuation">.</span>remove<span class="token punctuation">(</span><span class="token string">'./alldata.list'</span><span class="token punctuation">)</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'./alldata.list'</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> alldata<span class="token punctuation">:</span>
        <span class="token keyword">for</span> files <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">for</span> img_path <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span><span class="token string">'%s/%s'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>path<span class="token punctuation">,</span> files<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                alldata<span class="token punctuation">.</span>write<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>path<span class="token punctuation">,</span> img_path<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\t'</span> <span class="token operator">+</span> files <span class="token operator">+</span> <span class="token string">'\n'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'列表已生成'</span><span class="token punctuation">)</span>

make_path_list<span class="token punctuation">(</span>r<span class="token string">'/home/aistudio/data/data29044/GestureC'</span><span class="token punctuation">)</span>
</code></pre>
<ol start="2">
<li><strong>按照7:2:1的比例将数据集变为训练数据集、测试数据集、验证数据集</strong></li>
</ol>
<pre><code class="prism language-python"><span class="token comment"># 引入依赖的包</span>
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
digital_count_dict <span class="token operator">=</span> get_sample_count<span class="token punctuation">(</span>r<span class="token string">'/home/aistudio/data/data29044/GestureC'</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">split_dataset</span><span class="token punctuation">(</span>listpath<span class="token punctuation">,</span> test_p<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">,</span> eval_p<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span> count_dict<span class="token operator">=</span>digital_count_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 每次运行更新</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token string">'./train_data.list'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        os<span class="token punctuation">.</span>remove<span class="token punctuation">(</span><span class="token string">'./train_data.list'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token string">'./test_data.list'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        os<span class="token punctuation">.</span>remove<span class="token punctuation">(</span><span class="token string">'./test_data.list'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token string">'./eval_data.list'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        os<span class="token punctuation">.</span>remove<span class="token punctuation">(</span><span class="token string">'./eval_data.list'</span><span class="token punctuation">)</span>
    
    start_sign <span class="token operator">=</span> <span class="token number">10</span>
 
    <span class="token comment"># 开始分割数据集合</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>r<span class="token string">'%s/alldata.list'</span> <span class="token operator">%</span> listpath<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            lines <span class="token operator">=</span> f<span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> line <span class="token keyword">in</span> lines<span class="token punctuation">:</span>
                img<span class="token punctuation">,</span> label <span class="token operator">=</span> line<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'\t'</span><span class="token punctuation">)</span>

                <span class="token comment"># 说明是新的手势</span>
                <span class="token keyword">if</span> label <span class="token operator">!=</span> start_sign<span class="token punctuation">:</span>
                    count_sign <span class="token operator">=</span> <span class="token number">0</span>
                    <span class="token comment"># 得到该手势的总数 </span>
                    total_count <span class="token operator">=</span> count_dict<span class="token punctuation">[</span>label<span class="token punctuation">]</span>
                    <span class="token comment"># 用于测试的</span>
                    test_count <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>total_count <span class="token operator">*</span> test_p<span class="token punctuation">)</span>
                    <span class="token comment"># 用于验证的</span>
                    eval_count <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>total_count <span class="token operator">*</span> eval_p<span class="token punctuation">)</span>
                    <span class="token comment"># 该手势的图片编号</span>
                    total_sign <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>total_count<span class="token punctuation">)</span>
                    <span class="token comment"># 随机打乱</span>
                    np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>shuffle<span class="token punctuation">(</span>total_sign<span class="token punctuation">)</span>
                    <span class="token comment"># 测试的编号</span>
                    test_sign <span class="token operator">=</span> total_sign<span class="token punctuation">[</span><span class="token punctuation">:</span> test_count<span class="token punctuation">]</span>
                    <span class="token comment"># 验证的编号</span>
                    eval_sign <span class="token operator">=</span> total_sign<span class="token punctuation">[</span>test_count<span class="token punctuation">:</span> <span class="token punctuation">(</span>test_count <span class="token operator">+</span> eval_count<span class="token punctuation">)</span><span class="token punctuation">]</span>
                
                <span class="token keyword">if</span> count_sign <span class="token keyword">in</span> test_sign<span class="token punctuation">:</span>
                    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'./test_data.list'</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> test_data<span class="token punctuation">:</span>
                        test_data<span class="token punctuation">.</span>write<span class="token punctuation">(</span>line<span class="token punctuation">)</span>
                <span class="token keyword">elif</span> count_sign <span class="token keyword">in</span> eval_sign<span class="token punctuation">:</span>
                    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'./eval_data.list'</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> eval_data<span class="token punctuation">:</span>
                        eval_data<span class="token punctuation">.</span>write<span class="token punctuation">(</span>line<span class="token punctuation">)</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'./train_data.list'</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> train_data<span class="token punctuation">:</span>
                        train_data<span class="token punctuation">.</span>write<span class="token punctuation">(</span>line<span class="token punctuation">)</span>
                count_sign <span class="token operator">+=</span> <span class="token number">1</span>
                start_sign <span class="token operator">=</span> label

    <span class="token keyword">return</span> <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'数据集分割完成'</span><span class="token punctuation">)</span>

split_dataset<span class="token punctuation">(</span>r<span class="token string">'/home/aistudio/data/data29044'</span><span class="token punctuation">)</span>
</code></pre>
<pre><code class="prism language-python"><span class="token comment"># 看一下各个数据集的样本总数以及各个类别的数</span>
<span class="token keyword">def</span> <span class="token function">view_dataset</span><span class="token punctuation">(</span>listpath<span class="token punctuation">)</span><span class="token punctuation">:</span>
    count_dict <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">for</span> ij <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>listpath<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token string">'.list'</span> <span class="token keyword">in</span> ij<span class="token punctuation">:</span>
            type_dict <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
            <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>r<span class="token string">'%s/%s'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>listpath<span class="token punctuation">,</span> ij<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
                lines <span class="token operator">=</span> f<span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span>
                count <span class="token operator">=</span> <span class="token number">0</span>
                <span class="token keyword">for</span> line <span class="token keyword">in</span> lines<span class="token punctuation">:</span>
                    img<span class="token punctuation">,</span> label <span class="token operator">=</span> line<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'\t'</span><span class="token punctuation">)</span>
                    <span class="token keyword">if</span> label <span class="token keyword">in</span> type_dict<span class="token punctuation">:</span>
                        type_dict<span class="token punctuation">[</span>label<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>
                    <span class="token keyword">else</span><span class="token punctuation">:</span>
                        type_dict<span class="token punctuation">[</span>label<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>
                    count <span class="token operator">+=</span> <span class="token number">1</span>
            count_dict<span class="token punctuation">[</span>ij<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> type_dict<span class="token punctuation">]</span>
    <span class="token keyword">return</span> count_dict
                    
view_dataset<span class="token punctuation">(</span>r<span class="token string">'/home/aistudio/data/data29044'</span><span class="token punctuation">)</span>

<span class="token punctuation">{</span><span class="token string">'eval_data.list'</span><span class="token punctuation">:</span> 
<span class="token punctuation">[</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token string">'8'</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span><span class="token string">'0'</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span><span class="token string">'9'</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span><span class="token string">'7'</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span><span class="token string">'5'</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span><span class="token string">'3'</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span><span class="token string">'6'</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span><span class="token string">'4'</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span><span class="token string">'2'</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
 <span class="token string">'test_data.list'</span><span class="token punctuation">:</span> 
 <span class="token punctuation">[</span><span class="token number">409</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'8'</span><span class="token punctuation">:</span> <span class="token number">41</span><span class="token punctuation">,</span><span class="token string">'0'</span><span class="token punctuation">:</span> <span class="token number">41</span><span class="token punctuation">,</span><span class="token string">'9'</span><span class="token punctuation">:</span> <span class="token number">40</span><span class="token punctuation">,</span><span class="token string">'7'</span><span class="token punctuation">:</span> <span class="token number">41</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">:</span> <span class="token number">41</span><span class="token punctuation">,</span><span class="token string">'5'</span><span class="token punctuation">:</span> <span class="token number">41</span><span class="token punctuation">,</span><span class="token string">'3'</span><span class="token punctuation">:</span> <span class="token number">41</span><span class="token punctuation">,</span><span class="token string">'6'</span><span class="token punctuation">:</span> <span class="token number">41</span><span class="token punctuation">,</span><span class="token string">'4'</span><span class="token punctuation">:</span> <span class="token number">41</span><span class="token punctuation">,</span><span class="token string">'2'</span><span class="token punctuation">:</span> <span class="token number">41</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
 <span class="token string">'train_data.list'</span><span class="token punctuation">:</span> 
 <span class="token punctuation">[</span><span class="token number">1453</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token string">'8'</span><span class="token punctuation">:</span> <span class="token number">147</span><span class="token punctuation">,</span><span class="token string">'0'</span><span class="token punctuation">:</span> <span class="token number">144</span><span class="token punctuation">,</span> <span class="token string">'9'</span><span class="token punctuation">:</span> <span class="token number">144</span><span class="token punctuation">,</span><span class="token string">'7'</span><span class="token punctuation">:</span> <span class="token number">145</span><span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">:</span> <span class="token number">145</span><span class="token punctuation">,</span><span class="token string">'5'</span><span class="token punctuation">:</span> <span class="token number">146</span><span class="token punctuation">,</span><span class="token string">'3'</span><span class="token punctuation">:</span> <span class="token number">145</span><span class="token punctuation">,</span><span class="token string">'6'</span><span class="token punctuation">:</span> <span class="token number">146</span><span class="token punctuation">,</span><span class="token string">'4'</span><span class="token punctuation">:</span> <span class="token number">146</span><span class="token punctuation">,</span><span class="token string">'2'</span><span class="token punctuation">:</span> <span class="token number">145</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
 <span class="token string">'alldata.list'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">2062</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'8'</span><span class="token punctuation">:</span> <span class="token number">208</span><span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">:</span> <span class="token number">205</span><span class="token punctuation">,</span><span class="token string">'9'</span><span class="token punctuation">:</span> <span class="token number">204</span><span class="token punctuation">,</span><span class="token string">'7'</span><span class="token punctuation">:</span> <span class="token number">206</span><span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">:</span> <span class="token number">206</span><span class="token punctuation">,</span><span class="token string">'5'</span><span class="token punctuation">:</span> <span class="token number">207</span><span class="token punctuation">,</span><span class="token string">'3'</span><span class="token punctuation">:</span> <span class="token number">206</span><span class="token punctuation">,</span><span class="token string">'6'</span><span class="token punctuation">:</span> <span class="token number">207</span><span class="token punctuation">,</span><span class="token string">'4'</span><span class="token punctuation">:</span> <span class="token number">207</span><span class="token punctuation">,</span><span class="token string">'2'</span><span class="token punctuation">:</span> <span class="token number">206</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
</code></pre>
<ol start="3">
<li><strong>将数据集合变为PaddlePaddle框架中的数据流的形式</strong></li>
</ol>
<pre><code class="prism language-python"><span class="token comment"># 定义数据集的reader</span>
<span class="token keyword">def</span> <span class="token function">data_mapper</span><span class="token punctuation">(</span>sample<span class="token punctuation">)</span><span class="token punctuation">:</span>
    img<span class="token punctuation">,</span> label <span class="token operator">=</span> sample
    img <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span>
    <span class="token comment"># 利用平滑采样的方式将图片变为100*100的</span>
    img <span class="token operator">=</span> img<span class="token punctuation">.</span>resize<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Image<span class="token punctuation">.</span>ANTIALIAS<span class="token punctuation">)</span>
    img <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'float32'</span><span class="token punctuation">)</span>
    <span class="token comment"># 归一化</span>
    img <span class="token operator">=</span> img<span class="token operator">/</span><span class="token number">255.0</span>
    <span class="token keyword">return</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> label

<span class="token keyword">def</span> <span class="token function">data_reader</span><span class="token punctuation">(</span>data_list_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">reader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>data_list_path<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            lines <span class="token operator">=</span> f<span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> line <span class="token keyword">in</span> lines<span class="token punctuation">:</span>
                img<span class="token punctuation">,</span> label <span class="token operator">=</span> line<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'\t'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> paddle<span class="token punctuation">.</span>reader<span class="token punctuation">.</span>xmap_readers<span class="token punctuation">(</span>data_mapper<span class="token punctuation">,</span> reader<span class="token punctuation">,</span> cpu_count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">)</span>

<span class="token comment"># 用于训练的数据提供器</span>
train_reader <span class="token operator">=</span> paddle<span class="token punctuation">.</span>batch<span class="token punctuation">(</span>reader<span class="token operator">=</span>paddle<span class="token punctuation">.</span>reader<span class="token punctuation">.</span>shuffle<span class="token punctuation">(</span>reader<span class="token operator">=</span>data_reader<span class="token punctuation">(</span><span class="token string">'./train_data.list'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> buf_size<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span>
<span class="token comment"># 用于测试的数据提供器</span>
test_reader <span class="token operator">=</span> paddle<span class="token punctuation">.</span>batch<span class="token punctuation">(</span>reader<span class="token operator">=</span>data_reader<span class="token punctuation">(</span><span class="token string">'./test_data.list'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span> 
<span class="token comment"># 用于验证的数据提供器</span>
eval_reader <span class="token operator">=</span> paddle<span class="token punctuation">.</span>batch<span class="token punctuation">(</span>reader<span class="token operator">=</span>data_reader<span class="token punctuation">(</span><span class="token string">'./eval_data.list'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span> 
</code></pre>
<h5><a id="_163"></a>三、构建卷积神经网络</h5>
<pre><code class="prism language-python"><span class="token comment"># 引入需要的包</span>
<span class="token keyword">import</span> paddle<span class="token punctuation">.</span>fluid <span class="token keyword">as</span> fluid
<span class="token keyword">import</span> paddle<span class="token punctuation">.</span>fluid<span class="token punctuation">.</span>layers <span class="token keyword">as</span> layers
<span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> cpu_count
<span class="token keyword">from</span> paddle<span class="token punctuation">.</span>fluid<span class="token punctuation">.</span>dygraph <span class="token keyword">import</span> Pool2D<span class="token punctuation">,</span>Conv2D
<span class="token keyword">from</span> paddle<span class="token punctuation">.</span>fluid<span class="token punctuation">.</span>dygraph <span class="token keyword">import</span> Linear
</code></pre>
<pre><code class="prism language-python"><span class="token comment"># 配置卷积神经网络</span>
bp_config <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'learningrate'</span><span class="token punctuation">:</span> <span class="token number">0.002</span><span class="token punctuation">,</span> <span class="token string">'iters'</span><span class="token punctuation">:</span> <span class="token number">500</span><span class="token punctuation">}</span>
<span class="token comment"># 定义网络</span>
<span class="token keyword">class</span> <span class="token class-name">CNNBP</span><span class="token punctuation">(</span>fluid<span class="token punctuation">.</span>dygraph<span class="token punctuation">.</span>Layer<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>CNNBP<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 卷积层</span>
        self<span class="token punctuation">.</span>conv1 <span class="token operator">=</span> Conv2D<span class="token punctuation">(</span>num_channels<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> num_filters<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span> filter_size<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> act<span class="token operator">=</span><span class="token string">'relu'</span><span class="token punctuation">)</span>
        <span class="token comment"># 池化层</span>
        self<span class="token punctuation">.</span>pool1 <span class="token operator">=</span> Pool2D<span class="token punctuation">(</span>pool_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> pool_stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> pool_type<span class="token operator">=</span><span class="token string">'max'</span><span class="token punctuation">,</span> pool_padding<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token comment"># 卷积层</span>
        self<span class="token punctuation">.</span>conv2 <span class="token operator">=</span> Conv2D<span class="token punctuation">(</span>num_channels<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span> num_filters<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> filter_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> act<span class="token operator">=</span><span class="token string">'relu'</span><span class="token punctuation">)</span>
        <span class="token comment"># 池化层</span>
        self<span class="token punctuation">.</span>pool2 <span class="token operator">=</span> Pool2D<span class="token punctuation">(</span>pool_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> pool_stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> pool_type<span class="token operator">=</span><span class="token string">'max'</span><span class="token punctuation">,</span> pool_padding<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token comment"># 卷积层</span>
        self<span class="token punctuation">.</span>conv3 <span class="token operator">=</span> Conv2D<span class="token punctuation">(</span>num_channels<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> num_filters<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span> filter_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> act<span class="token operator">=</span><span class="token string">'relu'</span><span class="token punctuation">)</span>
        <span class="token comment"># 全连接层</span>
        self<span class="token punctuation">.</span>hidden1 <span class="token operator">=</span> Linear<span class="token punctuation">(</span><span class="token number">16</span><span class="token operator">*</span><span class="token number">21</span><span class="token operator">*</span><span class="token number">21</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">,</span> act<span class="token operator">=</span><span class="token string">'relu'</span><span class="token punctuation">)</span>
        <span class="token comment"># 输出层</span>
        self<span class="token punctuation">.</span>hidden2 <span class="token operator">=</span> Linear<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> act<span class="token operator">=</span><span class="token string">'softmax'</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token builtin">input</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>conv1<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>pool1<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>conv2<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>pool2<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>conv3<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token comment"># 全连接层之前需要将数据的维度变为(1, N)</span>
        x <span class="token operator">=</span> layers<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token comment"># 防止过拟合</span>
        x <span class="token operator">=</span> fluid<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>dropout<span class="token punctuation">(</span>x<span class="token punctuation">,</span> dropout_prob<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>hidden1<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token comment"># 防止过拟合</span>
        x <span class="token operator">=</span> fluid<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>dropout<span class="token punctuation">(</span>x<span class="token punctuation">,</span> dropout_prob<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span>
        y <span class="token operator">=</span> self<span class="token punctuation">.</span>hidden2<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token keyword">return</span> y
</code></pre>
<h5><a id="_212"></a>四、训练</h5>
<p>每迭代完一次，进行测试数据集的误差和精确度计算，如果满足设定的条件则保存模型，最后选择在测试数据集上表现最后的模型用于验证。</p>
<pre><code class="prism language-python"><span class="token comment"># 输出验证数据集、测试数据集的误差以及精确度</span>
train_loss_plot <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
train_acc_plot <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

test_loss_plot <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
test_acc_plot <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token comment">#用动态图进行训练</span>
<span class="token keyword">with</span> fluid<span class="token punctuation">.</span>dygraph<span class="token punctuation">.</span>guard<span class="token punctuation">(</span>fluid<span class="token punctuation">.</span>CUDAPlace<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 其中fluid.CUDAPlace(0)表示用GPU训练，否则为空。</span>
    model<span class="token operator">=</span>CNNBP<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#模型实例化</span>
    model<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#训练模式</span>
    <span class="token comment"># 优化求解器</span>
    opt<span class="token operator">=</span>fluid<span class="token punctuation">.</span>optimizer<span class="token punctuation">.</span>SGDOptimizer<span class="token punctuation">(</span>learning_rate<span class="token operator">=</span>bp_config<span class="token punctuation">[</span><span class="token string">'learningrate'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> parameter_list<span class="token operator">=</span>model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> pass_num <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>bp_config<span class="token punctuation">[</span><span class="token string">'iters'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'迭代次数：'</span><span class="token punctuation">,</span> pass_num<span class="token punctuation">)</span>
        <span class="token comment"># 记录训练数据的误差和精确度</span>
        batch_train_loss <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        batch_train_acc <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> batch_id<span class="token punctuation">,</span> data <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>train_reader<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

            images<span class="token operator">=</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> data<span class="token punctuation">]</span><span class="token punctuation">,</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>

            labels <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> data<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'int64'</span><span class="token punctuation">)</span>
            labels <span class="token operator">=</span> labels<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>newaxis<span class="token punctuation">]</span>

            image<span class="token operator">=</span>fluid<span class="token punctuation">.</span>dygraph<span class="token punctuation">.</span>to_variable<span class="token punctuation">(</span>images<span class="token punctuation">)</span>
            label<span class="token operator">=</span>fluid<span class="token punctuation">.</span>dygraph<span class="token punctuation">.</span>to_variable<span class="token punctuation">(</span>labels<span class="token punctuation">)</span>
            predict<span class="token operator">=</span>model<span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token comment">#预测</span>

            loss<span class="token operator">=</span>fluid<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>cross_entropy<span class="token punctuation">(</span>predict<span class="token punctuation">,</span>label<span class="token punctuation">)</span>
            avg_loss<span class="token operator">=</span>fluid<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>loss<span class="token punctuation">)</span><span class="token comment">#获取loss值</span>
          
            acc<span class="token operator">=</span>fluid<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>accuracy<span class="token punctuation">(</span>predict<span class="token punctuation">,</span>label<span class="token punctuation">)</span><span class="token comment">#计算精度</span>
            <span class="token comment"># 存储训练数据集的</span>
            batch_train_loss<span class="token punctuation">.</span>append<span class="token punctuation">(</span>avg_loss<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            batch_train_acc<span class="token punctuation">.</span>append<span class="token punctuation">(</span>acc<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

            avg_loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
            opt<span class="token punctuation">.</span>minimize<span class="token punctuation">(</span>avg_loss<span class="token punctuation">)</span>
            model<span class="token punctuation">.</span>clear_gradients<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># 计算测试数据的精确度以及loss</span>
        taccs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> test_batch_id<span class="token punctuation">,</span> test_data <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>test_reader<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment">#测试集</span>
            test_images<span class="token operator">=</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> test_data<span class="token punctuation">]</span><span class="token punctuation">,</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
            test_labels <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> test_data<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'int64'</span><span class="token punctuation">)</span>
            test_labels <span class="token operator">=</span> test_labels<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>newaxis<span class="token punctuation">]</span>

            timage<span class="token operator">=</span>fluid<span class="token punctuation">.</span>dygraph<span class="token punctuation">.</span>to_variable<span class="token punctuation">(</span>test_images<span class="token punctuation">)</span>
            tlabel<span class="token operator">=</span>fluid<span class="token punctuation">.</span>dygraph<span class="token punctuation">.</span>to_variable<span class="token punctuation">(</span>test_labels<span class="token punctuation">)</span>
            
            tpredict<span class="token operator">=</span>model<span class="token punctuation">(</span>timage<span class="token punctuation">)</span>       
            tacc<span class="token operator">=</span>fluid<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>accuracy<span class="token punctuation">(</span>tpredict<span class="token punctuation">,</span> tlabel<span class="token punctuation">)</span>
            tloss<span class="token operator">=</span>fluid<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>cross_entropy<span class="token punctuation">(</span>tpredict<span class="token punctuation">,</span> tlabel<span class="token punctuation">)</span>
            taccs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>tacc<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            tavg_acc <span class="token operator">=</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>taccs<span class="token punctuation">)</span>

        <span class="token comment"># 存储测试数据结果</span>
        test_loss_plot<span class="token punctuation">.</span>append<span class="token punctuation">(</span>np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>tloss<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        test_acc_plot<span class="token punctuation">.</span>append<span class="token punctuation">(</span>tavg_acc<span class="token punctuation">)</span>
        <span class="token comment"># 存储训练数据集结果</span>
        train_loss_result <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>batch_train_loss<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>batch_train_loss<span class="token punctuation">)</span>
        train_acc_result <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>batch_train_acc<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>batch_train_acc<span class="token punctuation">)</span>
        train_loss_plot<span class="token punctuation">.</span>append<span class="token punctuation">(</span>train_loss_result<span class="token punctuation">)</span>
        train_acc_plot<span class="token punctuation">.</span>append<span class="token punctuation">(</span>train_acc_result<span class="token punctuation">)</span>

        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'训练数据集：误差'</span><span class="token punctuation">,</span> train_loss_result<span class="token punctuation">,</span> <span class="token string">'正确率'</span><span class="token punctuation">,</span> train_acc_result<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'测试数据集：误差'</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>tloss<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'正确率'</span><span class="token punctuation">,</span> tavg_acc<span class="token punctuation">)</span>

        <span class="token comment"># 保存的模型</span>
        <span class="token keyword">if</span> train_acc_result <span class="token operator">&gt;</span> <span class="token number">0.95</span> <span class="token operator">and</span> tavg_acc <span class="token operator">&gt;</span> <span class="token number">0.88</span><span class="token punctuation">:</span> <span class="token comment"># 训练数据达到0.95以后就保存模型</span>
            fluid<span class="token punctuation">.</span>save_dygraph<span class="token punctuation">(</span>model<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'./para/CNNBP%s'</span> <span class="token operator">%</span> pass_num<span class="token punctuation">)</span>

</code></pre>
<pre><code class="prism language-python">迭代次数： <span class="token number">495</span>
训练数据集：误差 <span class="token punctuation">[</span><span class="token number">0.05399397</span><span class="token punctuation">]</span> 正确率 <span class="token punctuation">[</span><span class="token number">0.98145604</span><span class="token punctuation">]</span>
测试数据集：误差 <span class="token number">0.3810585</span> 正确率 <span class="token number">0.9151923</span>
迭代次数： <span class="token number">496</span>
训练数据集：误差 <span class="token punctuation">[</span><span class="token number">0.03725699</span><span class="token punctuation">]</span> 正确率 <span class="token punctuation">[</span><span class="token number">0.98832417</span><span class="token punctuation">]</span>
测试数据集：误差 <span class="token number">1.1552259</span> 正确率 <span class="token number">0.8939423</span>
迭代次数： <span class="token number">497</span>
训练数据集：误差 <span class="token punctuation">[</span><span class="token number">0.04244164</span><span class="token punctuation">]</span> 正确率 <span class="token punctuation">[</span><span class="token number">0.98832417</span><span class="token punctuation">]</span>
测试数据集：误差 <span class="token number">0.55333513</span> 正确率 <span class="token number">0.89528847</span>
迭代次数： <span class="token number">498</span>
训练数据集：误差 <span class="token punctuation">[</span><span class="token number">0.04658408</span><span class="token punctuation">]</span> 正确率 <span class="token punctuation">[</span><span class="token number">0.9855769</span><span class="token punctuation">]</span>
测试数据集：误差 <span class="token number">0.6396506</span> 正确率 <span class="token number">0.87125003</span>
迭代次数： <span class="token number">499</span>
训练数据集：误差 <span class="token punctuation">[</span><span class="token number">0.03801583</span><span class="token punctuation">]</span> 正确率 <span class="token punctuation">[</span><span class="token number">0.9869506</span><span class="token punctuation">]</span>
测试数据集：误差 <span class="token number">0.07386498</span> 正确率 <span class="token number">0.89355767</span>
</code></pre>
<p>绘制出训练和测试数据集上的误差、精确度的对比曲线。</p>
<pre><code class="prism language-python"><span class="token comment"># 绘制图片</span>
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">from</span> pylab <span class="token keyword">import</span> mpl
mpl<span class="token punctuation">.</span>rcParams<span class="token punctuation">[</span><span class="token string">'font.sans-serif'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'FangSong'</span><span class="token punctuation">]</span>  <span class="token comment"># 显示中文</span>
mpl<span class="token punctuation">.</span>rcParams<span class="token punctuation">[</span><span class="token string">'axes.unicode_minus'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">False</span>  <span class="token comment"># 显示负号</span>

<span class="token comment"># 绘制训练数据集和测试数据集的对比曲线</span>
<span class="token keyword">def</span> <span class="token function">draw_loss</span><span class="token punctuation">(</span>traindata<span class="token punctuation">,</span> testdata<span class="token punctuation">,</span> yl<span class="token operator">=</span><span class="token string">'loss'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'train VS test'</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">24</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">"iters"</span><span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span>yl<span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>traindata<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> traindata<span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'red'</span><span class="token punctuation">,</span>label<span class="token operator">=</span><span class="token string">'Train'</span><span class="token punctuation">)</span> 
    plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>testdata<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> testdata<span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'green'</span><span class="token punctuation">,</span>label<span class="token operator">=</span><span class="token string">'Test'</span><span class="token punctuation">)</span> 
    plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>grid<span class="token punctuation">(</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>

draw_loss<span class="token punctuation">(</span>train_loss_plot<span class="token punctuation">,</span> test_loss_plot<span class="token punctuation">)</span>
draw_loss<span class="token punctuation">(</span>train_acc_plot<span class="token punctuation">,</span> test_acc_plot<span class="token punctuation">,</span> <span class="token string">'Acc'</span><span class="token punctuation">)</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200409143553909.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzMyODgyMzA5,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/2020040914360663.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzMyODgyMzA5,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<h5><a id="_332"></a>五、验证数据集准确度</h5>
<pre><code class="prism language-python"><span class="token comment"># 根据测试数据集合的精确率选择效果最后的模型</span>
judge_best <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>i<span class="token punctuation">,</span> test_acc_plot<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> test_loss_plot<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>test_acc_plot<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
best_model_sign <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>judge_best<span class="token punctuation">,</span> key<span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token operator">-</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> x<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

<span class="token comment"># 根据得到的最好的模型针对验证数据集进行精确率的计算</span>
<span class="token keyword">with</span> fluid<span class="token punctuation">.</span>dygraph<span class="token punctuation">.</span>guard<span class="token punctuation">(</span>fluid<span class="token punctuation">.</span>CUDAPlace<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    accs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    model_dict<span class="token punctuation">,</span> _ <span class="token operator">=</span> fluid<span class="token punctuation">.</span>load_dygraph<span class="token punctuation">(</span><span class="token string">'./para/CNNBP%s'</span> <span class="token operator">%</span> best_model_sign<span class="token punctuation">)</span>
    model <span class="token operator">=</span> CNNBP<span class="token punctuation">(</span><span class="token punctuation">)</span>
    model<span class="token punctuation">.</span>load_dict<span class="token punctuation">(</span>model_dict<span class="token punctuation">)</span> <span class="token comment">#加载模型参数</span>
    model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#训练模式</span>
    <span class="token keyword">for</span> batch_id<span class="token punctuation">,</span>data <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>eval_reader<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment">#测试集</span>
        images<span class="token operator">=</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> data<span class="token punctuation">]</span><span class="token punctuation">,</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
        labels <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> data<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'int64'</span><span class="token punctuation">)</span>
        labels <span class="token operator">=</span> labels<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>newaxis<span class="token punctuation">]</span>

        image<span class="token operator">=</span>fluid<span class="token punctuation">.</span>dygraph<span class="token punctuation">.</span>to_variable<span class="token punctuation">(</span>images<span class="token punctuation">)</span>
        label<span class="token operator">=</span>fluid<span class="token punctuation">.</span>dygraph<span class="token punctuation">.</span>to_variable<span class="token punctuation">(</span>labels<span class="token punctuation">)</span>
        
        predict<span class="token operator">=</span>model<span class="token punctuation">(</span>image<span class="token punctuation">)</span>       
        acc<span class="token operator">=</span>fluid<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>accuracy<span class="token punctuation">(</span>predict<span class="token punctuation">,</span>label<span class="token punctuation">)</span>
        accs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>acc<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        avg_acc <span class="token operator">=</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>accs<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>avg_acc<span class="token punctuation">)</span>
    
<span class="token number">0.96428573</span>
</code></pre>
<h5><a id="_361"></a>六、预测</h5>
<p>根据自己上传的图片，利用该模型进行预测。</p>
<pre><code class="prism language-python"><span class="token comment"># 判断自己上传的照片的准确率,</span>
<span class="token keyword">def</span> <span class="token function">predict_picture</span><span class="token punctuation">(</span>path<span class="token operator">=</span><span class="token string">'/home/aistudio/data/data29044/MyPicture'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># path 存储自己图片的文件夹.其中图片名称的第一个字符必须为图片中手势表示的数字</span>
    <span class="token keyword">for</span> p <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        d_name <span class="token operator">=</span> p<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token comment"># 图片的路径</span>
        filepath <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>path<span class="token punctuation">,</span> p<span class="token punctuation">)</span>
        img <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>filepath<span class="token punctuation">)</span>
        <span class="token comment"># 将分辨率调制一样</span>
        img <span class="token operator">=</span> img<span class="token punctuation">.</span>resize<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Image<span class="token punctuation">.</span>ANTIALIAS<span class="token punctuation">)</span>
        img <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'float32'</span><span class="token punctuation">)</span>
        img <span class="token operator">=</span> img<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        img <span class="token operator">=</span> img<span class="token operator">/</span><span class="token number">255.0</span>
        <span class="token comment">#构建预测动态图过程</span>
        <span class="token keyword">with</span> fluid<span class="token punctuation">.</span>dygraph<span class="token punctuation">.</span>guard<span class="token punctuation">(</span>fluid<span class="token punctuation">.</span>CUDAPlace<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            model<span class="token operator">=</span>CNNBP<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#模型实例化</span>
            model_dict<span class="token punctuation">,</span>_<span class="token operator">=</span>fluid<span class="token punctuation">.</span>load_dygraph<span class="token punctuation">(</span><span class="token string">'./para/CNNBP%s'</span> <span class="token operator">%</span> best_model_sign<span class="token punctuation">)</span>
            model<span class="token punctuation">.</span>load_dict<span class="token punctuation">(</span>model_dict<span class="token punctuation">)</span><span class="token comment">#加载模型参数</span>
            model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#评估模式</span>

            infer_img<span class="token operator">=</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span><span class="token string">'float32'</span><span class="token punctuation">)</span>
            infer_img<span class="token operator">=</span>infer_img<span class="token punctuation">[</span>np<span class="token punctuation">.</span>newaxis<span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span> <span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
            infer_img <span class="token operator">=</span> fluid<span class="token punctuation">.</span>dygraph<span class="token punctuation">.</span>to_variable<span class="token punctuation">(</span>infer_img<span class="token punctuation">)</span>
            <span class="token comment"># 预测得到的softmax结果</span>
            result<span class="token operator">=</span>model<span class="token punctuation">(</span>infer_img<span class="token punctuation">)</span>
            <span class="token comment"># 展示图片</span>
            display<span class="token punctuation">(</span>Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>filepath<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'真实数字为:'</span><span class="token punctuation">,</span> d_name<span class="token punctuation">,</span> <span class="token string">'预测的数字为'</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>result<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<p><img src="https://img-blog.csdnimg.cn/20200409150949867.png#pic_center" alt="在这里插入图片描述"><br>
<a href="https://github.com/Anfany/Python-3-Project-Practice">点击</a>获得更多项目源码。欢迎Follow，感谢Star!!!  扫描关注微信公众号<strong>pythonfan</strong>，获取更多。<br>
<img src="https://imgconvert.csdnimg.cn/aHR0cDovL3VwbG9hZC1pbWFnZXMuamlhbnNodS5pby91cGxvYWRfaW1hZ2VzLzQ3MzQyMjAtYzY1MGI4OTg0ZGI0MzAyMA?x-oss-process=image/format,png" alt="image"><img src="https://imgconvert.csdnimg.cn/aHR0cDovL3VwbG9hZC1pbWFnZXMuamlhbnNodS5pby91cGxvYWRfaW1hZ2VzLzQ3MzQyMjAtNjRhZTkwYzMyZGJlMTJlOQ?x-oss-process=image/format,png" alt="image"></p>
</div>
</body>

</html>
